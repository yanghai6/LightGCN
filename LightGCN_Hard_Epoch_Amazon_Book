{"cells":[{"cell_type":"markdown","metadata":{"id":"_OmjR8Fd9VT9"},"source":["# Global Setting and Imports"]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"elapsed":27894,"status":"ok","timestamp":1702418501778,"user":{"displayName":"Yining Wang","userId":"16697420739328446910"},"user_tz":300},"id":"pW6gFrGr8kHI","outputId":"c1f3d3b9-31c2-42e5-c4d3-15d603a85161"},"outputs":[{"output_type":"stream","name":"stdout","text":["Mounted at /content/gdrive\n"]}],"source":["# In order to make things work on google drive\n","import os\n","from google.colab import drive\n","\n","drive.mount('/content/gdrive', force_remount=True)\n","os.chdir('/content/gdrive/MyDrive/Colab Notebooks/LightGCN')"]},{"cell_type":"code","execution_count":null,"metadata":{"executionInfo":{"elapsed":26504,"status":"ok","timestamp":1702418528280,"user":{"displayName":"Yining Wang","userId":"16697420739328446910"},"user_tz":300},"id":"yNb6VAL89RMa","colab":{"base_uri":"https://localhost:8080/"},"outputId":"6e2fbf95-69dd-48e9-d721-c0cb40a270d4"},"outputs":[{"output_type":"stream","name":"stdout","text":["Collecting scrapbook\n","  Downloading scrapbook-0.5.0-py3-none-any.whl (34 kB)\n","Requirement already satisfied: pandas in /usr/local/lib/python3.10/dist-packages (from scrapbook) (1.5.3)\n","Collecting papermill (from scrapbook)\n","  Downloading papermill-2.5.0-py3-none-any.whl (38 kB)\n","Requirement already satisfied: jsonschema in /usr/local/lib/python3.10/dist-packages (from scrapbook) (4.19.2)\n","Requirement already satisfied: ipython in /usr/local/lib/python3.10/dist-packages (from scrapbook) (7.34.0)\n","Requirement already satisfied: pyarrow in /usr/local/lib/python3.10/dist-packages (from scrapbook) (10.0.1)\n","Requirement already satisfied: setuptools>=18.5 in /usr/local/lib/python3.10/dist-packages (from ipython->scrapbook) (67.7.2)\n","Collecting jedi>=0.16 (from ipython->scrapbook)\n","  Downloading jedi-0.19.1-py2.py3-none-any.whl (1.6 MB)\n","\u001b[2K     \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m1.6/1.6 MB\u001b[0m \u001b[31m26.1 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n","\u001b[?25hRequirement already satisfied: decorator in /usr/local/lib/python3.10/dist-packages (from ipython->scrapbook) (4.4.2)\n","Requirement already satisfied: pickleshare in /usr/local/lib/python3.10/dist-packages (from ipython->scrapbook) (0.7.5)\n","Requirement already satisfied: traitlets>=4.2 in /usr/local/lib/python3.10/dist-packages (from ipython->scrapbook) (5.7.1)\n","Requirement already satisfied: prompt-toolkit!=3.0.0,!=3.0.1,<3.1.0,>=2.0.0 in /usr/local/lib/python3.10/dist-packages (from ipython->scrapbook) (3.0.41)\n","Requirement already satisfied: pygments in /usr/local/lib/python3.10/dist-packages (from ipython->scrapbook) (2.16.1)\n","Requirement already satisfied: backcall in /usr/local/lib/python3.10/dist-packages (from ipython->scrapbook) (0.2.0)\n","Requirement already satisfied: matplotlib-inline in /usr/local/lib/python3.10/dist-packages (from ipython->scrapbook) (0.1.6)\n","Requirement already satisfied: pexpect>4.3 in /usr/local/lib/python3.10/dist-packages (from ipython->scrapbook) (4.9.0)\n","Requirement already satisfied: attrs>=22.2.0 in /usr/local/lib/python3.10/dist-packages (from jsonschema->scrapbook) (23.1.0)\n","Requirement already satisfied: jsonschema-specifications>=2023.03.6 in /usr/local/lib/python3.10/dist-packages (from jsonschema->scrapbook) (2023.11.2)\n","Requirement already satisfied: referencing>=0.28.4 in /usr/local/lib/python3.10/dist-packages (from jsonschema->scrapbook) (0.31.1)\n","Requirement already satisfied: rpds-py>=0.7.1 in /usr/local/lib/python3.10/dist-packages (from jsonschema->scrapbook) (0.13.2)\n","Requirement already satisfied: python-dateutil>=2.8.1 in /usr/local/lib/python3.10/dist-packages (from pandas->scrapbook) (2.8.2)\n","Requirement already satisfied: pytz>=2020.1 in /usr/local/lib/python3.10/dist-packages (from pandas->scrapbook) (2023.3.post1)\n","Requirement already satisfied: numpy>=1.21.0 in /usr/local/lib/python3.10/dist-packages (from pandas->scrapbook) (1.23.5)\n","Requirement already satisfied: click in /usr/local/lib/python3.10/dist-packages (from papermill->scrapbook) (8.1.7)\n","Requirement already satisfied: pyyaml in /usr/local/lib/python3.10/dist-packages (from papermill->scrapbook) (6.0.1)\n","Requirement already satisfied: nbformat>=5.1.2 in /usr/local/lib/python3.10/dist-packages (from papermill->scrapbook) (5.9.2)\n","Requirement already satisfied: nbclient>=0.2.0 in /usr/local/lib/python3.10/dist-packages (from papermill->scrapbook) (0.9.0)\n","Requirement already satisfied: tqdm>=4.32.2 in /usr/local/lib/python3.10/dist-packages (from papermill->scrapbook) (4.66.1)\n","Requirement already satisfied: requests in /usr/local/lib/python3.10/dist-packages (from papermill->scrapbook) (2.31.0)\n","Requirement already satisfied: entrypoints in /usr/local/lib/python3.10/dist-packages (from papermill->scrapbook) (0.4)\n","Requirement already satisfied: tenacity>=5.0.2 in /usr/local/lib/python3.10/dist-packages (from papermill->scrapbook) (8.2.3)\n","Requirement already satisfied: parso<0.9.0,>=0.8.3 in /usr/local/lib/python3.10/dist-packages (from jedi>=0.16->ipython->scrapbook) (0.8.3)\n","Requirement already satisfied: jupyter-client>=6.1.12 in /usr/local/lib/python3.10/dist-packages (from nbclient>=0.2.0->papermill->scrapbook) (6.1.12)\n","Requirement already satisfied: jupyter-core!=5.0.*,>=4.12 in /usr/local/lib/python3.10/dist-packages (from nbclient>=0.2.0->papermill->scrapbook) (5.5.0)\n","Requirement already satisfied: fastjsonschema in /usr/local/lib/python3.10/dist-packages (from nbformat>=5.1.2->papermill->scrapbook) (2.19.0)\n","Requirement already satisfied: ptyprocess>=0.5 in /usr/local/lib/python3.10/dist-packages (from pexpect>4.3->ipython->scrapbook) (0.7.0)\n","Requirement already satisfied: wcwidth in /usr/local/lib/python3.10/dist-packages (from prompt-toolkit!=3.0.0,!=3.0.1,<3.1.0,>=2.0.0->ipython->scrapbook) (0.2.12)\n","Requirement already satisfied: six>=1.5 in /usr/local/lib/python3.10/dist-packages (from python-dateutil>=2.8.1->pandas->scrapbook) (1.16.0)\n","Requirement already satisfied: charset-normalizer<4,>=2 in /usr/local/lib/python3.10/dist-packages (from requests->papermill->scrapbook) (3.3.2)\n","Requirement already satisfied: idna<4,>=2.5 in /usr/local/lib/python3.10/dist-packages (from requests->papermill->scrapbook) (3.6)\n","Requirement already satisfied: urllib3<3,>=1.21.1 in /usr/local/lib/python3.10/dist-packages (from requests->papermill->scrapbook) (2.0.7)\n","Requirement already satisfied: certifi>=2017.4.17 in /usr/local/lib/python3.10/dist-packages (from requests->papermill->scrapbook) (2023.11.17)\n","Requirement already satisfied: pyzmq>=13 in /usr/local/lib/python3.10/dist-packages (from jupyter-client>=6.1.12->nbclient>=0.2.0->papermill->scrapbook) (23.2.1)\n","Requirement already satisfied: tornado>=4.1 in /usr/local/lib/python3.10/dist-packages (from jupyter-client>=6.1.12->nbclient>=0.2.0->papermill->scrapbook) (6.3.2)\n","Requirement already satisfied: platformdirs>=2.5 in /usr/local/lib/python3.10/dist-packages (from jupyter-core!=5.0.*,>=4.12->nbclient>=0.2.0->papermill->scrapbook) (4.1.0)\n","Installing collected packages: jedi, papermill, scrapbook\n","Successfully installed jedi-0.19.1 papermill-2.5.0 scrapbook-0.5.0\n","Collecting retrying\n","  Downloading retrying-1.3.4-py3-none-any.whl (11 kB)\n","Requirement already satisfied: six>=1.7.0 in /usr/local/lib/python3.10/dist-packages (from retrying) (1.16.0)\n","Installing collected packages: retrying\n","Successfully installed retrying-1.3.4\n","Collecting pandera\n","  Downloading pandera-0.18.0-py3-none-any.whl (209 kB)\n","\u001b[2K     \u001b[90m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\u001b[0m \u001b[32m209.0/209.0 kB\u001b[0m \u001b[31m4.4 MB/s\u001b[0m eta \u001b[36m0:00:00\u001b[0m\n","\u001b[?25hCollecting multimethod (from pandera)\n","  Downloading multimethod-1.10-py3-none-any.whl (9.9 kB)\n","Requirement already satisfied: numpy>=1.19.0 in /usr/local/lib/python3.10/dist-packages (from pandera) (1.23.5)\n","Requirement already satisfied: packaging>=20.0 in /usr/local/lib/python3.10/dist-packages (from pandera) (23.2)\n","Requirement already satisfied: pandas>=1.2.0 in /usr/local/lib/python3.10/dist-packages (from pandera) (1.5.3)\n","Requirement already satisfied: pydantic in /usr/local/lib/python3.10/dist-packages (from pandera) (1.10.13)\n","Collecting typeguard>=3.0.2 (from pandera)\n","  Downloading typeguard-4.1.5-py3-none-any.whl (34 kB)\n","Collecting typing-inspect>=0.6.0 (from pandera)\n","  Downloading typing_inspect-0.9.0-py3-none-any.whl (8.8 kB)\n","Requirement already satisfied: wrapt in /usr/local/lib/python3.10/dist-packages (from pandera) (1.14.1)\n","Requirement already satisfied: python-dateutil>=2.8.1 in /usr/local/lib/python3.10/dist-packages (from pandas>=1.2.0->pandera) (2.8.2)\n","Requirement already satisfied: pytz>=2020.1 in /usr/local/lib/python3.10/dist-packages (from pandas>=1.2.0->pandera) (2023.3.post1)\n","Collecting typing-extensions>=4.7.0 (from typeguard>=3.0.2->pandera)\n","  Downloading typing_extensions-4.9.0-py3-none-any.whl (32 kB)\n","Collecting mypy-extensions>=0.3.0 (from typing-inspect>=0.6.0->pandera)\n","  Downloading mypy_extensions-1.0.0-py3-none-any.whl (4.7 kB)\n","Requirement already satisfied: six>=1.5 in /usr/local/lib/python3.10/dist-packages (from python-dateutil>=2.8.1->pandas>=1.2.0->pandera) (1.16.0)\n","Installing collected packages: typing-extensions, mypy-extensions, multimethod, typing-inspect, typeguard, pandera\n","  Attempting uninstall: typing-extensions\n","    Found existing installation: typing_extensions 4.5.0\n","    Uninstalling typing_extensions-4.5.0:\n","      Successfully uninstalled typing_extensions-4.5.0\n","\u001b[31mERROR: pip's dependency resolver does not currently take into account all the packages that are installed. This behaviour is the source of the following dependency conflicts.\n","tensorflow-probability 0.22.0 requires typing-extensions<4.6.0, but you have typing-extensions 4.9.0 which is incompatible.\u001b[0m\u001b[31m\n","\u001b[0mSuccessfully installed multimethod-1.10 mypy-extensions-1.0.0 pandera-0.18.0 typeguard-4.1.5 typing-extensions-4.9.0 typing-inspect-0.9.0\n"]}],"source":["!pip install scrapbook\n","!pip install retrying\n","!pip install pandera"]},{"cell_type":"code","execution_count":null,"metadata":{"executionInfo":{"elapsed":25492,"status":"ok","timestamp":1702418559234,"user":{"displayName":"Yining Wang","userId":"16697420739328446910"},"user_tz":300},"id":"S0zsn1Ky9RWq","colab":{"base_uri":"https://localhost:8080/"},"outputId":"0ba9eb8a-20f1-4d8b-991e-63bff2500c14"},"outputs":[{"output_type":"stream","name":"stdout","text":["System version: 3.10.12 (main, Nov 20 2023, 15:14:05) [GCC 11.4.0]\n","Pandas version: 1.5.3\n","Tensorflow version: 2.14.0\n"]}],"source":["import sys\n","import scrapbook as sb\n","import pandas as pd\n","import numpy as np\n","import tensorflow as tf\n","import random\n","tf.get_logger().setLevel('ERROR') # only show error messages\n","\n","from recommenders.utils.timer import Timer\n","from recommenders.models.deeprec.models.graphrec.lightgcn import LightGCN\n","from recommenders.models.deeprec.DataModel.ImplicitCF import ImplicitCF\n","from recommenders.datasets import movielens\n","from recommenders.datasets.python_splitters import python_stratified_split\n","from recommenders.evaluation.python_evaluation import map_at_k, ndcg_at_k, precision_at_k, recall_at_k\n","from recommenders.utils.constants import SEED as DEFAULT_SEED\n","from recommenders.models.deeprec.deeprec_utils import prepare_hparams\n","\n","print(\"System version: {}\".format(sys.version))\n","print(\"Pandas version: {}\".format(pd.__version__))\n","print(\"Tensorflow version: {}\".format(tf.__version__))"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"_g5HDt-u9RaT"},"outputs":[],"source":["# top k items to recommend\n","TOP_K = 10\n","\n","# Select MovieLens data size: 100k, 1m, 10m, or 20m\n","MOVIELENS_DATA_SIZE = '100k'\n","DATA_SIZE = 1584082\n","\n","# Model parameters\n","EPOCHS = 30\n","BATCH_SIZE = 512\n","\n","SEED = DEFAULT_SEED  # Set None for non-deterministic results\n","\n","yaml_file = \"recommenders/models/deeprec/config/lightgcn.yaml\"\n","# user_file = \"tests/resources/deeprec/lightgcn/user_embeddings.csv\"\n","# item_file = \"tests/resources/deeprec/lightgcn/item_embeddings.csv\""]},{"cell_type":"markdown","metadata":{"id":"7lmozlYo_CBF"},"source":["# Load and Split Data"]},{"cell_type":"code","source":["path = \"recommenders/datasets/amazon-book/\"\n","train_file = path + '/train.txt'\n","data = []\n","\n","\n","with open(train_file) as f:\n","    for l in f.readlines()[:1000]: # take first 2000 users\n","        if len(l) > 0:\n","            l = l.strip('\\n').split(' ')\n","            items = [int(i) for i in l[1:] if int(i) < 1000]\n","            uid = int(l[0])\n","            for item_id in items:\n","                timestamp = random.randint(100000000, 999999999)\n","                data.append([uid, item_id, 5.0, timestamp])\n","\n","df = pd.DataFrame(data, columns=['userID', 'itemID', 'rating', 'timestamp'])\n","train, test = python_stratified_split(df, ratio=0.75)\n","print(train.head)\n","print(test.head)\n","data = ImplicitCF(train=train, test=test, seed=SEED)"],"metadata":{"id":"Ea7qwFmy0B17","executionInfo":{"status":"ok","timestamp":1702419936347,"user_tz":300,"elapsed":4,"user":{"displayName":"Yining Wang","userId":"16697420739328446910"}},"colab":{"base_uri":"https://localhost:8080/"},"outputId":"3879e5f1-47a5-45f5-e56c-64db62214b7e"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["<bound method NDFrame.head of       userID  itemID  rating  timestamp\n","10         0      10     5.0  865993393\n","42         0      42     5.0  837844676\n","29         0      29     5.0  981843514\n","6          0       6     5.0  572015874\n","32         0      32     5.0  752439557\n","...      ...     ...     ...        ...\n","8595     997     435     5.0  954063385\n","8589     997     619     5.0  963108341\n","8594     997     696     5.0  640151232\n","8587     997     107     5.0  909940801\n","8598     999     367     5.0  995050475\n","\n","[6521 rows x 4 columns]>\n","<bound method NDFrame.head of       userID  itemID  rating  timestamp\n","2          0       2     5.0  547621163\n","51         0      51     5.0  268819460\n","25         0      25     5.0  880213880\n","35         0      35     5.0  405340067\n","12         0      12     5.0  741221312\n","...      ...     ...     ...        ...\n","8581     997     167     5.0  154841838\n","8590     997     439     5.0  675692544\n","8586     997     171     5.0  226408946\n","8582     997     387     5.0  318319483\n","8593     997     279     5.0  506309840\n","\n","[2078 rows x 4 columns]>\n"]}]},{"cell_type":"markdown","metadata":{"id":"GOeHQWPYEo8M"},"source":["# Prepare Hyper-parameters"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"02E3GfSIEthb"},"outputs":[],"source":["hparams = prepare_hparams(yaml_file,\n","                          n_layers=3,\n","                          batch_size=BATCH_SIZE,\n","                          epochs=EPOCHS,\n","                          learning_rate=0.005,\n","                          eval_epoch=5,\n","                          top_k=TOP_K,\n","                         )"]},{"cell_type":"markdown","source":["# Baseline Model"],"metadata":{"id":"dY9c_gqvnFWD"}},{"cell_type":"code","source":["model_amazon_base = LightGCN(hparams, data, seed=SEED)\n","\n","with Timer() as train_time:\n","    model_amazon_base.fit()\n","\n","print(\"Took {} seconds for training.\".format(train_time.interval))"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1702420115559,"user_tz":300,"elapsed":3804,"user":{"displayName":"Yining Wang","userId":"16697420739328446910"}},"outputId":"777cd52e-bca3-451c-a7d5-c5ba915e1afa","id":"TAMzMwxa15hF"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["Already create adjacency matrix.\n","Already normalize adjacency matrix.\n","Using xavier initialization.\n","Epoch 1 (train)0.4s: train loss = 0.68369 = (mf)0.68366 + (embed)0.00003\n","Epoch 2 (train)0.1s: train loss = 0.64297 = (mf)0.64291 + (embed)0.00006\n","Epoch 3 (train)0.1s: train loss = 0.54828 = (mf)0.54814 + (embed)0.00014\n","Epoch 4 (train)0.1s: train loss = 0.41316 = (mf)0.41288 + (embed)0.00028\n","Epoch 5 (train)0.1s + (eval)0.1s: train loss = 0.31045 = (mf)0.31000 + (embed)0.00045, recall = 0.13208, ndcg = 0.09329, precision = 0.03037, map = 0.06212\n","Epoch 6 (train)0.1s: train loss = 0.23767 = (mf)0.23705 + (embed)0.00062\n","Epoch 7 (train)0.1s: train loss = 0.20431 = (mf)0.20354 + (embed)0.00077\n","Epoch 8 (train)0.1s: train loss = 0.17760 = (mf)0.17670 + (embed)0.00090\n","Epoch 9 (train)0.1s: train loss = 0.15374 = (mf)0.15273 + (embed)0.00101\n","Epoch 10 (train)0.1s + (eval)0.1s: train loss = 0.13956 = (mf)0.13846 + (embed)0.00110, recall = 0.15995, ndcg = 0.11751, precision = 0.04038, map = 0.07739\n","Epoch 11 (train)0.1s: train loss = 0.12152 = (mf)0.12032 + (embed)0.00119\n","Epoch 12 (train)0.1s: train loss = 0.11249 = (mf)0.11122 + (embed)0.00127\n","Epoch 13 (train)0.1s: train loss = 0.10454 = (mf)0.10319 + (embed)0.00135\n","Epoch 14 (train)0.1s: train loss = 0.10207 = (mf)0.10064 + (embed)0.00143\n","Epoch 15 (train)0.1s + (eval)0.1s: train loss = 0.08488 = (mf)0.08339 + (embed)0.00149, recall = 0.17833, ndcg = 0.13279, precision = 0.04547, map = 0.08734\n","Epoch 16 (train)0.1s: train loss = 0.08712 = (mf)0.08556 + (embed)0.00156\n","Epoch 17 (train)0.1s: train loss = 0.08508 = (mf)0.08345 + (embed)0.00162\n","Epoch 18 (train)0.1s: train loss = 0.07209 = (mf)0.07040 + (embed)0.00168\n","Epoch 19 (train)0.1s: train loss = 0.07057 = (mf)0.06883 + (embed)0.00175\n","Epoch 20 (train)0.1s + (eval)0.1s: train loss = 0.06635 = (mf)0.06455 + (embed)0.00180, recall = 0.18972, ndcg = 0.13773, precision = 0.04913, map = 0.08931\n","Epoch 21 (train)0.1s: train loss = 0.06449 = (mf)0.06263 + (embed)0.00186\n","Epoch 22 (train)0.1s: train loss = 0.05656 = (mf)0.05464 + (embed)0.00192\n","Epoch 23 (train)0.1s: train loss = 0.05703 = (mf)0.05506 + (embed)0.00197\n","Epoch 24 (train)0.1s: train loss = 0.05470 = (mf)0.05267 + (embed)0.00202\n","Epoch 25 (train)0.1s + (eval)0.1s: train loss = 0.05180 = (mf)0.04974 + (embed)0.00206, recall = 0.20471, ndcg = 0.14693, precision = 0.05358, map = 0.09479\n","Epoch 26 (train)0.1s: train loss = 0.04861 = (mf)0.04650 + (embed)0.00211\n","Epoch 27 (train)0.1s: train loss = 0.04914 = (mf)0.04698 + (embed)0.00216\n","Epoch 28 (train)0.1s: train loss = 0.04409 = (mf)0.04189 + (embed)0.00220\n","Epoch 29 (train)0.1s: train loss = 0.04383 = (mf)0.04160 + (embed)0.00223\n","Epoch 30 (train)0.1s + (eval)0.1s: train loss = 0.04191 = (mf)0.03963 + (embed)0.00228, recall = 0.19422, ndcg = 0.14427, precision = 0.05183, map = 0.09472\n","Took 2.6436073669999587 seconds for training.\n"]}]},{"cell_type":"code","source":["topk_scores = model_amazon_base.recommend_k_items(test, top_k=TOP_K, remove_seen=True)\n","\n","eval_map = map_at_k(test, topk_scores, k=TOP_K)\n","eval_ndcg = ndcg_at_k(test, topk_scores, k=TOP_K)\n","eval_precision = precision_at_k(test, topk_scores, k=TOP_K)\n","eval_recall = recall_at_k(test, topk_scores, k=TOP_K)\n","\n","print(\"MAP:\\t%f\" % eval_map,\n","      \"NDCG:\\t%f\" % eval_ndcg,\n","      \"Precision@K:\\t%f\" % eval_precision,\n","      \"Recall@K:\\t%f\" % eval_recall, sep='\\n')"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1702420117797,"user_tz":300,"elapsed":3,"user":{"displayName":"Yining Wang","userId":"16697420739328446910"}},"outputId":"fbade0dc-c38e-4fc5-c8b3-c3726c9bce7b","id":"_xFUrQXr15hG"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["MAP:\t0.094720\n","NDCG:\t0.144274\n","Precision@K:\t0.051828\n","Recall@K:\t0.194224\n"]}]},{"cell_type":"markdown","source":["# Hard Negative Sampling (Batch)"],"metadata":{"id":"u40KJ03Xnk_9"}},{"cell_type":"markdown","source":["## Round 1"],"metadata":{"id":"Cbjb4rQbqAMJ"}},{"cell_type":"code","source":["model_amazon_hard = LightGCN(hparams, data, seed=SEED)"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1702419946222,"user_tz":300,"elapsed":328,"user":{"displayName":"Yining Wang","userId":"16697420739328446910"}},"outputId":"91bca9cc-7af0-4943-d31d-ff664b1afe1f","id":"YBLsiNsep9oz"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["Already create adjacency matrix.\n","Already normalize adjacency matrix.\n","Using xavier initialization.\n"]}]},{"cell_type":"code","execution_count":null,"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"outputId":"b0584541-0ea3-48f2-9998-2b1160a822fd","id":"7Fu_voDOp9o7","executionInfo":{"status":"ok","timestamp":1702420030492,"user_tz":300,"elapsed":84271,"user":{"displayName":"Yining Wang","userId":"16697420739328446910"}}},"outputs":[{"output_type":"stream","name":"stdout","text":["Epoch 1 (train)0.4s: train loss = 0.68394 = (mf)0.68391 + (embed)0.00003\n","Epoch 2 (train)81.0s: train loss = 0.64368 = (mf)0.64362 + (embed)0.00007\n","Epoch 3 (train)0.1s: train loss = 0.55683 = (mf)0.55667 + (embed)0.00015\n","Epoch 4 (train)0.1s: train loss = 0.43011 = (mf)0.42981 + (embed)0.00030\n","Epoch 5 (train)0.1s + (eval)0.1s: train loss = 0.32085 = (mf)0.32036 + (embed)0.00049, recall = 0.13117, ndcg = 0.09643, precision = 0.03148, map = 0.06472\n","Epoch 6 (train)0.1s: train loss = 0.25177 = (mf)0.25109 + (embed)0.00068\n","Epoch 7 (train)0.1s: train loss = 0.21745 = (mf)0.21660 + (embed)0.00085\n","Epoch 8 (train)0.1s: train loss = 0.17852 = (mf)0.17754 + (embed)0.00099\n","Epoch 9 (train)0.1s: train loss = 0.16502 = (mf)0.16391 + (embed)0.00111\n","Epoch 10 (train)0.1s + (eval)0.1s: train loss = 0.14807 = (mf)0.14685 + (embed)0.00122, recall = 0.16748, ndcg = 0.12103, precision = 0.04181, map = 0.07923\n","Epoch 11 (train)0.1s: train loss = 0.12745 = (mf)0.12612 + (embed)0.00132\n","Epoch 12 (train)0.1s: train loss = 0.10887 = (mf)0.10744 + (embed)0.00143\n","Epoch 13 (train)0.1s: train loss = 0.11277 = (mf)0.11125 + (embed)0.00153\n","Epoch 14 (train)0.1s: train loss = 0.10167 = (mf)0.10005 + (embed)0.00161\n","Epoch 15 (train)0.1s + (eval)0.1s: train loss = 0.09342 = (mf)0.09172 + (embed)0.00170, recall = 0.18848, ndcg = 0.13779, precision = 0.04738, map = 0.08974\n","Epoch 16 (train)0.1s: train loss = 0.08125 = (mf)0.07947 + (embed)0.00179\n","Epoch 17 (train)0.1s: train loss = 0.08028 = (mf)0.07842 + (embed)0.00187\n","Epoch 18 (train)0.1s: train loss = 0.07475 = (mf)0.07281 + (embed)0.00193\n","Epoch 19 (train)0.1s: train loss = 0.06816 = (mf)0.06616 + (embed)0.00200\n","Epoch 20 (train)0.1s + (eval)0.1s: train loss = 0.06667 = (mf)0.06460 + (embed)0.00207, recall = 0.19053, ndcg = 0.14463, precision = 0.04913, map = 0.09594\n","Epoch 21 (train)0.1s: train loss = 0.05935 = (mf)0.05721 + (embed)0.00214\n","Epoch 22 (train)0.1s: train loss = 0.06229 = (mf)0.06009 + (embed)0.00219\n","Epoch 23 (train)0.1s: train loss = 0.05629 = (mf)0.05402 + (embed)0.00226\n","Epoch 24 (train)0.1s: train loss = 0.05560 = (mf)0.05329 + (embed)0.00232\n","Epoch 25 (train)0.1s + (eval)0.1s: train loss = 0.05130 = (mf)0.04893 + (embed)0.00237, recall = 0.19309, ndcg = 0.15030, precision = 0.05183, map = 0.10040\n","Epoch 26 (train)0.1s: train loss = 0.04929 = (mf)0.04686 + (embed)0.00243\n","Epoch 27 (train)0.1s: train loss = 0.04521 = (mf)0.04274 + (embed)0.00247\n","Epoch 28 (train)0.1s: train loss = 0.04567 = (mf)0.04315 + (embed)0.00252\n","Epoch 29 (train)0.1s: train loss = 0.03873 = (mf)0.03617 + (embed)0.00256\n","Epoch 30 (train)0.1s + (eval)0.1s: train loss = 0.04293 = (mf)0.04031 + (embed)0.00262, recall = 0.19568, ndcg = 0.15248, precision = 0.05215, map = 0.10269\n","Took 84.656414584 seconds for training.\n"]}],"source":["with Timer() as train_time:\n","    model_amazon_hard.fit(neg_mode=\"epoch\", neg_size=50)\n","\n","print(\"Took {} seconds for training.\".format(train_time.interval))"]},{"cell_type":"code","source":["topk_scores = model_amazon_hard.recommend_k_items(test, top_k=TOP_K, remove_seen=True)\n","\n","topk_scores.head()"],"metadata":{"id":"NoJUlqMnp9o7","colab":{"base_uri":"https://localhost:8080/","height":206},"executionInfo":{"status":"ok","timestamp":1702420102242,"user_tz":300,"elapsed":385,"user":{"displayName":"Yining Wang","userId":"16697420739328446910"}},"outputId":"5681bd09-60ea-4232-8190-15e73412cb35"},"execution_count":null,"outputs":[{"output_type":"execute_result","data":{"text/plain":["   userID  itemID  prediction\n","0       0     775   11.938348\n","1       0     118   10.567196\n","2       0      56   10.077603\n","3       0     670    9.274241\n","4       0     429    9.243658"],"text/html":["\n","  <div id=\"df-1e369478-5d4d-4278-9e83-91f0ecaf5c21\" class=\"colab-df-container\">\n","    <div>\n","<style scoped>\n","    .dataframe tbody tr th:only-of-type {\n","        vertical-align: middle;\n","    }\n","\n","    .dataframe tbody tr th {\n","        vertical-align: top;\n","    }\n","\n","    .dataframe thead th {\n","        text-align: right;\n","    }\n","</style>\n","<table border=\"1\" class=\"dataframe\">\n","  <thead>\n","    <tr style=\"text-align: right;\">\n","      <th></th>\n","      <th>userID</th>\n","      <th>itemID</th>\n","      <th>prediction</th>\n","    </tr>\n","  </thead>\n","  <tbody>\n","    <tr>\n","      <th>0</th>\n","      <td>0</td>\n","      <td>775</td>\n","      <td>11.938348</td>\n","    </tr>\n","    <tr>\n","      <th>1</th>\n","      <td>0</td>\n","      <td>118</td>\n","      <td>10.567196</td>\n","    </tr>\n","    <tr>\n","      <th>2</th>\n","      <td>0</td>\n","      <td>56</td>\n","      <td>10.077603</td>\n","    </tr>\n","    <tr>\n","      <th>3</th>\n","      <td>0</td>\n","      <td>670</td>\n","      <td>9.274241</td>\n","    </tr>\n","    <tr>\n","      <th>4</th>\n","      <td>0</td>\n","      <td>429</td>\n","      <td>9.243658</td>\n","    </tr>\n","  </tbody>\n","</table>\n","</div>\n","    <div class=\"colab-df-buttons\">\n","\n","  <div class=\"colab-df-container\">\n","    <button class=\"colab-df-convert\" onclick=\"convertToInteractive('df-1e369478-5d4d-4278-9e83-91f0ecaf5c21')\"\n","            title=\"Convert this dataframe to an interactive table.\"\n","            style=\"display:none;\">\n","\n","  <svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\" viewBox=\"0 -960 960 960\">\n","    <path d=\"M120-120v-720h720v720H120Zm60-500h600v-160H180v160Zm220 220h160v-160H400v160Zm0 220h160v-160H400v160ZM180-400h160v-160H180v160Zm440 0h160v-160H620v160ZM180-180h160v-160H180v160Zm440 0h160v-160H620v160Z\"/>\n","  </svg>\n","    </button>\n","\n","  <style>\n","    .colab-df-container {\n","      display:flex;\n","      gap: 12px;\n","    }\n","\n","    .colab-df-convert {\n","      background-color: #E8F0FE;\n","      border: none;\n","      border-radius: 50%;\n","      cursor: pointer;\n","      display: none;\n","      fill: #1967D2;\n","      height: 32px;\n","      padding: 0 0 0 0;\n","      width: 32px;\n","    }\n","\n","    .colab-df-convert:hover {\n","      background-color: #E2EBFA;\n","      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);\n","      fill: #174EA6;\n","    }\n","\n","    .colab-df-buttons div {\n","      margin-bottom: 4px;\n","    }\n","\n","    [theme=dark] .colab-df-convert {\n","      background-color: #3B4455;\n","      fill: #D2E3FC;\n","    }\n","\n","    [theme=dark] .colab-df-convert:hover {\n","      background-color: #434B5C;\n","      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);\n","      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));\n","      fill: #FFFFFF;\n","    }\n","  </style>\n","\n","    <script>\n","      const buttonEl =\n","        document.querySelector('#df-1e369478-5d4d-4278-9e83-91f0ecaf5c21 button.colab-df-convert');\n","      buttonEl.style.display =\n","        google.colab.kernel.accessAllowed ? 'block' : 'none';\n","\n","      async function convertToInteractive(key) {\n","        const element = document.querySelector('#df-1e369478-5d4d-4278-9e83-91f0ecaf5c21');\n","        const dataTable =\n","          await google.colab.kernel.invokeFunction('convertToInteractive',\n","                                                    [key], {});\n","        if (!dataTable) return;\n","\n","        const docLinkHtml = 'Like what you see? Visit the ' +\n","          '<a target=\"_blank\" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'\n","          + ' to learn more about interactive tables.';\n","        element.innerHTML = '';\n","        dataTable['output_type'] = 'display_data';\n","        await google.colab.output.renderOutput(dataTable, element);\n","        const docLink = document.createElement('div');\n","        docLink.innerHTML = docLinkHtml;\n","        element.appendChild(docLink);\n","      }\n","    </script>\n","  </div>\n","\n","\n","<div id=\"df-be2fe10b-d65c-44f8-8697-f494aa97d8fb\">\n","  <button class=\"colab-df-quickchart\" onclick=\"quickchart('df-be2fe10b-d65c-44f8-8697-f494aa97d8fb')\"\n","            title=\"Suggest charts\"\n","            style=\"display:none;\">\n","\n","<svg xmlns=\"http://www.w3.org/2000/svg\" height=\"24px\"viewBox=\"0 0 24 24\"\n","     width=\"24px\">\n","    <g>\n","        <path d=\"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z\"/>\n","    </g>\n","</svg>\n","  </button>\n","\n","<style>\n","  .colab-df-quickchart {\n","      --bg-color: #E8F0FE;\n","      --fill-color: #1967D2;\n","      --hover-bg-color: #E2EBFA;\n","      --hover-fill-color: #174EA6;\n","      --disabled-fill-color: #AAA;\n","      --disabled-bg-color: #DDD;\n","  }\n","\n","  [theme=dark] .colab-df-quickchart {\n","      --bg-color: #3B4455;\n","      --fill-color: #D2E3FC;\n","      --hover-bg-color: #434B5C;\n","      --hover-fill-color: #FFFFFF;\n","      --disabled-bg-color: #3B4455;\n","      --disabled-fill-color: #666;\n","  }\n","\n","  .colab-df-quickchart {\n","    background-color: var(--bg-color);\n","    border: none;\n","    border-radius: 50%;\n","    cursor: pointer;\n","    display: none;\n","    fill: var(--fill-color);\n","    height: 32px;\n","    padding: 0;\n","    width: 32px;\n","  }\n","\n","  .colab-df-quickchart:hover {\n","    background-color: var(--hover-bg-color);\n","    box-shadow: 0 1px 2px rgba(60, 64, 67, 0.3), 0 1px 3px 1px rgba(60, 64, 67, 0.15);\n","    fill: var(--button-hover-fill-color);\n","  }\n","\n","  .colab-df-quickchart-complete:disabled,\n","  .colab-df-quickchart-complete:disabled:hover {\n","    background-color: var(--disabled-bg-color);\n","    fill: var(--disabled-fill-color);\n","    box-shadow: none;\n","  }\n","\n","  .colab-df-spinner {\n","    border: 2px solid var(--fill-color);\n","    border-color: transparent;\n","    border-bottom-color: var(--fill-color);\n","    animation:\n","      spin 1s steps(1) infinite;\n","  }\n","\n","  @keyframes spin {\n","    0% {\n","      border-color: transparent;\n","      border-bottom-color: var(--fill-color);\n","      border-left-color: var(--fill-color);\n","    }\n","    20% {\n","      border-color: transparent;\n","      border-left-color: var(--fill-color);\n","      border-top-color: var(--fill-color);\n","    }\n","    30% {\n","      border-color: transparent;\n","      border-left-color: var(--fill-color);\n","      border-top-color: var(--fill-color);\n","      border-right-color: var(--fill-color);\n","    }\n","    40% {\n","      border-color: transparent;\n","      border-right-color: var(--fill-color);\n","      border-top-color: var(--fill-color);\n","    }\n","    60% {\n","      border-color: transparent;\n","      border-right-color: var(--fill-color);\n","    }\n","    80% {\n","      border-color: transparent;\n","      border-right-color: var(--fill-color);\n","      border-bottom-color: var(--fill-color);\n","    }\n","    90% {\n","      border-color: transparent;\n","      border-bottom-color: var(--fill-color);\n","    }\n","  }\n","</style>\n","\n","  <script>\n","    async function quickchart(key) {\n","      const quickchartButtonEl =\n","        document.querySelector('#' + key + ' button');\n","      quickchartButtonEl.disabled = true;  // To prevent multiple clicks.\n","      quickchartButtonEl.classList.add('colab-df-spinner');\n","      try {\n","        const charts = await google.colab.kernel.invokeFunction(\n","            'suggestCharts', [key], {});\n","      } catch (error) {\n","        console.error('Error during call to suggestCharts:', error);\n","      }\n","      quickchartButtonEl.classList.remove('colab-df-spinner');\n","      quickchartButtonEl.classList.add('colab-df-quickchart-complete');\n","    }\n","    (() => {\n","      let quickchartButtonEl =\n","        document.querySelector('#df-be2fe10b-d65c-44f8-8697-f494aa97d8fb button');\n","      quickchartButtonEl.style.display =\n","        google.colab.kernel.accessAllowed ? 'block' : 'none';\n","    })();\n","  </script>\n","</div>\n","\n","    </div>\n","  </div>\n"]},"metadata":{},"execution_count":33}]},{"cell_type":"code","source":["eval_map = map_at_k(test, topk_scores, k=TOP_K)\n","eval_ndcg = ndcg_at_k(test, topk_scores, k=TOP_K)\n","eval_precision = precision_at_k(test, topk_scores, k=TOP_K)\n","eval_recall = recall_at_k(test, topk_scores, k=TOP_K)\n","\n","print(\"MAP:\\t%f\" % eval_map,\n","      \"NDCG:\\t%f\" % eval_ndcg,\n","      \"Precision@K:\\t%f\" % eval_precision,\n","      \"Recall@K:\\t%f\" % eval_recall, sep='\\n')"],"metadata":{"id":"H22hZPA4p9o7","colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1702420105340,"user_tz":300,"elapsed":5,"user":{"displayName":"Yining Wang","userId":"16697420739328446910"}},"outputId":"6161a4cd-ed4c-43db-faa8-831c2cf579df"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["MAP:\t0.102688\n","NDCG:\t0.152483\n","Precision@K:\t0.052146\n","Recall@K:\t0.195684\n"]}]},{"cell_type":"markdown","source":["## Round 2"],"metadata":{"id":"eavXSFJjqEq3"}},{"cell_type":"code","source":["model_amazon_hard = LightGCN(hparams, data, seed=SEED)\n","\n","with Timer() as train_time:\n","    model_amazon_hard.fit(neg_mode=\"epoch\", neg_size=50)\n","\n","print(\"Took {} seconds for training.\".format(train_time.interval))"],"metadata":{"id":"aQ_yecgMy2py","colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1702420334134,"user_tz":300,"elapsed":82421,"user":{"displayName":"Yining Wang","userId":"16697420739328446910"}},"outputId":"81ad16ec-67cc-40e7-d07c-8cc5f40a7f0e"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["Already create adjacency matrix.\n","Already normalize adjacency matrix.\n","Using xavier initialization.\n","Epoch 1 (train)0.6s: train loss = 0.68347 = (mf)0.68345 + (embed)0.00003\n","Epoch 2 (train)77.2s: train loss = 0.64057 = (mf)0.64050 + (embed)0.00007\n","Epoch 3 (train)0.1s: train loss = 0.54189 = (mf)0.54174 + (embed)0.00016\n","Epoch 4 (train)0.1s: train loss = 0.40394 = (mf)0.40363 + (embed)0.00031\n","Epoch 5 (train)0.1s + (eval)0.1s: train loss = 0.30701 = (mf)0.30651 + (embed)0.00050, recall = 0.13175, ndcg = 0.09014, precision = 0.03100, map = 0.05708\n","Epoch 6 (train)0.1s: train loss = 0.24543 = (mf)0.24474 + (embed)0.00068\n","Epoch 7 (train)0.1s: train loss = 0.21785 = (mf)0.21702 + (embed)0.00083\n","Epoch 8 (train)0.1s: train loss = 0.19627 = (mf)0.19533 + (embed)0.00095\n","Epoch 9 (train)0.1s: train loss = 0.18254 = (mf)0.18147 + (embed)0.00107\n","Epoch 10 (train)0.1s + (eval)0.1s: train loss = 0.16730 = (mf)0.16613 + (embed)0.00118, recall = 0.16390, ndcg = 0.12253, precision = 0.03990, map = 0.08160\n","Epoch 11 (train)0.1s: train loss = 0.14460 = (mf)0.14331 + (embed)0.00128\n","Epoch 12 (train)0.1s: train loss = 0.12604 = (mf)0.12465 + (embed)0.00139\n","Epoch 13 (train)0.1s: train loss = 0.11809 = (mf)0.11661 + (embed)0.00148\n","Epoch 14 (train)0.1s: train loss = 0.10488 = (mf)0.10330 + (embed)0.00157\n","Epoch 15 (train)0.1s + (eval)0.1s: train loss = 0.09792 = (mf)0.09626 + (embed)0.00166, recall = 0.18686, ndcg = 0.13738, precision = 0.04610, map = 0.09018\n","Epoch 16 (train)0.1s: train loss = 0.09091 = (mf)0.08917 + (embed)0.00174\n","Epoch 17 (train)0.1s: train loss = 0.08536 = (mf)0.08354 + (embed)0.00181\n","Epoch 18 (train)0.1s: train loss = 0.07509 = (mf)0.07320 + (embed)0.00189\n","Epoch 19 (train)0.1s: train loss = 0.07613 = (mf)0.07415 + (embed)0.00197\n","Epoch 20 (train)0.1s + (eval)0.1s: train loss = 0.06856 = (mf)0.06652 + (embed)0.00203, recall = 0.19482, ndcg = 0.14335, precision = 0.04913, map = 0.09414\n","Epoch 21 (train)0.1s: train loss = 0.06341 = (mf)0.06131 + (embed)0.00210\n","Epoch 22 (train)0.1s: train loss = 0.06362 = (mf)0.06146 + (embed)0.00216\n","Epoch 23 (train)0.1s: train loss = 0.06168 = (mf)0.05947 + (embed)0.00221\n","Epoch 24 (train)0.1s: train loss = 0.05372 = (mf)0.05145 + (embed)0.00227\n","Epoch 25 (train)0.1s + (eval)0.1s: train loss = 0.05159 = (mf)0.04926 + (embed)0.00233, recall = 0.19844, ndcg = 0.14939, precision = 0.05183, map = 0.09894\n","Epoch 26 (train)0.1s: train loss = 0.04978 = (mf)0.04739 + (embed)0.00239\n","Epoch 27 (train)0.1s: train loss = 0.05155 = (mf)0.04911 + (embed)0.00244\n","Epoch 28 (train)0.1s: train loss = 0.04628 = (mf)0.04379 + (embed)0.00250\n","Epoch 29 (train)0.1s: train loss = 0.04400 = (mf)0.04145 + (embed)0.00254\n","Epoch 30 (train)0.1s + (eval)0.1s: train loss = 0.04408 = (mf)0.04149 + (embed)0.00258, recall = 0.19715, ndcg = 0.14983, precision = 0.05231, map = 0.09907\n","Took 80.94138780699996 seconds for training.\n"]}]},{"cell_type":"code","source":["topk_scores = model_amazon_hard.recommend_k_items(test, top_k=TOP_K, remove_seen=True)\n","\n","eval_map = map_at_k(test, topk_scores, k=TOP_K)\n","eval_ndcg = ndcg_at_k(test, topk_scores, k=TOP_K)\n","eval_precision = precision_at_k(test, topk_scores, k=TOP_K)\n","eval_recall = recall_at_k(test, topk_scores, k=TOP_K)\n","\n","print(\"MAP:\\t%f\" % eval_map,\n","      \"NDCG:\\t%f\" % eval_ndcg,\n","      \"Precision@K:\\t%f\" % eval_precision,\n","      \"Recall@K:\\t%f\" % eval_recall, sep='\\n')"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"executionInfo":{"status":"ok","timestamp":1702420334135,"user_tz":300,"elapsed":12,"user":{"displayName":"Yining Wang","userId":"16697420739328446910"}},"outputId":"5701a435-c5e3-4053-bda7-ccb9adafc2c4","id":"N56SSuvCy2p8"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["MAP:\t0.099066\n","NDCG:\t0.149833\n","Precision@K:\t0.052305\n","Recall@K:\t0.197151\n"]}]},{"cell_type":"markdown","source":["## Round3"],"metadata":{"id":"LUfsxnU6qMB5"}},{"cell_type":"code","source":["model_amazon_hard = LightGCN(hparams, data, seed=SEED)\n","\n","with Timer() as train_time:\n","    model_amazon_hard.fit(neg_mode=\"epoch\", neg_size=50)\n","\n","print(\"Took {} seconds for training.\".format(train_time.interval))"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"Fswf9Gadt-wD","executionInfo":{"status":"ok","timestamp":1702420416211,"user_tz":300,"elapsed":82083,"user":{"displayName":"Yining Wang","userId":"16697420739328446910"}},"outputId":"164f7961-67c1-4cbd-d8a1-294108704115"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["Already create adjacency matrix.\n","Already normalize adjacency matrix.\n","Using xavier initialization.\n","Epoch 1 (train)0.5s: train loss = 0.68347 = (mf)0.68344 + (embed)0.00003\n","Epoch 2 (train)77.9s: train loss = 0.63843 = (mf)0.63836 + (embed)0.00007\n","Epoch 3 (train)0.1s: train loss = 0.54513 = (mf)0.54497 + (embed)0.00015\n","Epoch 4 (train)0.1s: train loss = 0.40719 = (mf)0.40688 + (embed)0.00030\n","Epoch 5 (train)0.1s + (eval)0.1s: train loss = 0.30654 = (mf)0.30605 + (embed)0.00050, recall = 0.13287, ndcg = 0.09094, precision = 0.03148, map = 0.05853\n","Epoch 6 (train)0.1s: train loss = 0.24275 = (mf)0.24208 + (embed)0.00068\n","Epoch 7 (train)0.1s: train loss = 0.20582 = (mf)0.20498 + (embed)0.00084\n","Epoch 8 (train)0.1s: train loss = 0.18492 = (mf)0.18395 + (embed)0.00097\n","Epoch 9 (train)0.1s: train loss = 0.16199 = (mf)0.16091 + (embed)0.00108\n","Epoch 10 (train)0.1s + (eval)0.1s: train loss = 0.16477 = (mf)0.16359 + (embed)0.00119, recall = 0.16694, ndcg = 0.12121, precision = 0.04181, map = 0.07948\n","Epoch 11 (train)0.1s: train loss = 0.14348 = (mf)0.14220 + (embed)0.00128\n","Epoch 12 (train)0.1s: train loss = 0.13190 = (mf)0.13052 + (embed)0.00138\n","Epoch 13 (train)0.1s: train loss = 0.11584 = (mf)0.11437 + (embed)0.00148\n","Epoch 14 (train)0.1s: train loss = 0.10896 = (mf)0.10740 + (embed)0.00156\n","Epoch 15 (train)0.1s + (eval)0.1s: train loss = 0.09647 = (mf)0.09483 + (embed)0.00164, recall = 0.18679, ndcg = 0.13875, precision = 0.04642, map = 0.09329\n","Epoch 16 (train)0.1s: train loss = 0.08719 = (mf)0.08546 + (embed)0.00173\n","Epoch 17 (train)0.1s: train loss = 0.08197 = (mf)0.08017 + (embed)0.00180\n","Epoch 18 (train)0.1s: train loss = 0.07717 = (mf)0.07530 + (embed)0.00187\n","Epoch 19 (train)0.1s: train loss = 0.07546 = (mf)0.07353 + (embed)0.00193\n","Epoch 20 (train)0.1s + (eval)0.1s: train loss = 0.07278 = (mf)0.07078 + (embed)0.00200, recall = 0.19620, ndcg = 0.14433, precision = 0.04976, map = 0.09550\n","Epoch 21 (train)0.1s: train loss = 0.06823 = (mf)0.06615 + (embed)0.00207\n","Epoch 22 (train)0.1s: train loss = 0.05756 = (mf)0.05541 + (embed)0.00214\n","Epoch 23 (train)0.1s: train loss = 0.05567 = (mf)0.05346 + (embed)0.00220\n","Epoch 24 (train)0.1s: train loss = 0.05561 = (mf)0.05334 + (embed)0.00227\n","Epoch 25 (train)0.1s + (eval)0.1s: train loss = 0.05059 = (mf)0.04828 + (embed)0.00232, recall = 0.20229, ndcg = 0.14609, precision = 0.05294, map = 0.09421\n","Epoch 26 (train)0.1s: train loss = 0.05171 = (mf)0.04934 + (embed)0.00237\n","Epoch 27 (train)0.1s: train loss = 0.04891 = (mf)0.04647 + (embed)0.00244\n","Epoch 28 (train)0.1s: train loss = 0.04808 = (mf)0.04560 + (embed)0.00248\n","Epoch 29 (train)0.1s: train loss = 0.04545 = (mf)0.04291 + (embed)0.00254\n","Epoch 30 (train)0.1s + (eval)0.1s: train loss = 0.04665 = (mf)0.04407 + (embed)0.00258, recall = 0.20412, ndcg = 0.15172, precision = 0.05358, map = 0.10020\n","Took 81.55505591400015 seconds for training.\n"]}]},{"cell_type":"code","source":["topk_scores = model_amazon_hard.recommend_k_items(test, top_k=TOP_K, remove_seen=True)\n","\n","eval_map = map_at_k(test, topk_scores, k=TOP_K)\n","eval_ndcg = ndcg_at_k(test, topk_scores, k=TOP_K)\n","eval_precision = precision_at_k(test, topk_scores, k=TOP_K)\n","eval_recall = recall_at_k(test, topk_scores, k=TOP_K)\n","\n","print(\"MAP:\\t%f\" % eval_map,\n","      \"NDCG:\\t%f\" % eval_ndcg,\n","      \"Precision@K:\\t%f\" % eval_precision,\n","      \"Recall@K:\\t%f\" % eval_recall, sep='\\n')"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"CmLLqA9Qt-wD","executionInfo":{"status":"ok","timestamp":1702420416211,"user_tz":300,"elapsed":29,"user":{"displayName":"Yining Wang","userId":"16697420739328446910"}},"outputId":"5415c082-7a11-4f50-b491-a18e590958f8"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["MAP:\t0.100197\n","NDCG:\t0.151719\n","Precision@K:\t0.053577\n","Recall@K:\t0.204123\n"]}]},{"cell_type":"markdown","source":["# Backup"],"metadata":{"id":"w80knzRVzIO_"}},{"cell_type":"code","source":["model_movie_hard = LightGCN(hparams, data, seed=SEED)\n","\n","with Timer() as train_time:\n","    model_movie_hard.fit(neg_mode=\"hard\", neg_size=10)\n","\n","print(\"Took {} seconds for training.\".format(train_time.interval))"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"lFdI46R2t-32","executionInfo":{"status":"ok","timestamp":1702414067719,"user_tz":300,"elapsed":65398,"user":{"displayName":"Haiyue Yang","userId":"01341272776966740941"}},"outputId":"1de220cd-ddc6-44fe-f443-c45ebe2c9cf2"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["Already create adjacency matrix.\n","Already normalize adjacency matrix.\n","Using xavier initialization.\n","Epoch 1 (train)3.5s: train loss = 0.41073 = (mf)0.41033 + (embed)0.00040\n","Epoch 2 (train)1.9s: train loss = 0.27035 = (mf)0.26952 + (embed)0.00083\n","Epoch 3 (train)1.8s: train loss = 0.25703 = (mf)0.25596 + (embed)0.00107\n","Epoch 4 (train)1.8s: train loss = 0.23813 = (mf)0.23687 + (embed)0.00126\n","Epoch 5 (train)1.8s + (eval)0.2s: train loss = 0.22023 = (mf)0.21875 + (embed)0.00148, recall = 0.16635, ndcg = 0.36824, precision = 0.32428, map = 0.09793\n","Epoch 6 (train)1.8s: train loss = 0.20807 = (mf)0.20636 + (embed)0.00171\n","Epoch 7 (train)2.3s: train loss = 0.19484 = (mf)0.19289 + (embed)0.00195\n","Epoch 8 (train)2.6s: train loss = 0.19078 = (mf)0.18862 + (embed)0.00216\n","Epoch 9 (train)2.3s: train loss = 0.18683 = (mf)0.18451 + (embed)0.00232\n","Epoch 10 (train)1.9s + (eval)0.2s: train loss = 0.18281 = (mf)0.18032 + (embed)0.00249, recall = 0.18394, ndcg = 0.39113, precision = 0.34008, map = 0.11155\n","Epoch 11 (train)1.8s: train loss = 0.17772 = (mf)0.17509 + (embed)0.00264\n","Epoch 12 (train)1.8s: train loss = 0.17289 = (mf)0.17010 + (embed)0.00280\n","Epoch 13 (train)1.8s: train loss = 0.16607 = (mf)0.16310 + (embed)0.00296\n","Epoch 14 (train)1.9s: train loss = 0.16370 = (mf)0.16058 + (embed)0.00312\n","Epoch 15 (train)2.5s + (eval)0.3s: train loss = 0.16083 = (mf)0.15752 + (embed)0.00331, recall = 0.20080, ndcg = 0.42097, precision = 0.36819, map = 0.12436\n","Epoch 16 (train)2.5s: train loss = 0.15803 = (mf)0.15455 + (embed)0.00348\n","Epoch 17 (train)1.8s: train loss = 0.15320 = (mf)0.14955 + (embed)0.00366\n","Epoch 18 (train)1.8s: train loss = 0.15080 = (mf)0.14696 + (embed)0.00384\n","Epoch 19 (train)1.8s: train loss = 0.14655 = (mf)0.14252 + (embed)0.00403\n","Epoch 20 (train)1.8s + (eval)0.2s: train loss = 0.14422 = (mf)0.14001 + (embed)0.00421, recall = 0.20751, ndcg = 0.43475, precision = 0.37709, map = 0.13085\n","Epoch 21 (train)1.8s: train loss = 0.14050 = (mf)0.13610 + (embed)0.00440\n","Epoch 22 (train)2.2s: train loss = 0.13857 = (mf)0.13399 + (embed)0.00458\n","Epoch 23 (train)2.5s: train loss = 0.13745 = (mf)0.13267 + (embed)0.00477\n","Epoch 24 (train)2.4s: train loss = 0.13310 = (mf)0.12814 + (embed)0.00496\n","Epoch 25 (train)1.8s + (eval)0.2s: train loss = 0.12949 = (mf)0.12432 + (embed)0.00517, recall = 0.21085, ndcg = 0.44456, precision = 0.38770, map = 0.13417\n","Epoch 26 (train)1.8s: train loss = 0.12911 = (mf)0.12375 + (embed)0.00536\n","Epoch 27 (train)1.8s: train loss = 0.12437 = (mf)0.11884 + (embed)0.00553\n","Epoch 28 (train)1.9s: train loss = 0.12290 = (mf)0.11716 + (embed)0.00574\n","Epoch 29 (train)1.9s: train loss = 0.12152 = (mf)0.11557 + (embed)0.00595\n","Epoch 30 (train)2.5s + (eval)0.4s: train loss = 0.12050 = (mf)0.11435 + (embed)0.00615, recall = 0.21465, ndcg = 0.44774, precision = 0.39290, map = 0.13578\n","Took 63.57239398599995 seconds for training.\n"]}]},{"cell_type":"code","source":["topk_scores = model_movie_hard.recommend_k_items(test, top_k=TOP_K, remove_seen=True)\n","\n","eval_map = map_at_k(test, topk_scores, k=TOP_K)\n","eval_ndcg = ndcg_at_k(test, topk_scores, k=TOP_K)\n","eval_precision = precision_at_k(test, topk_scores, k=TOP_K)\n","eval_recall = recall_at_k(test, topk_scores, k=TOP_K)\n","\n","print(\"MAP:\\t%f\" % eval_map,\n","      \"NDCG:\\t%f\" % eval_ndcg,\n","      \"Precision@K:\\t%f\" % eval_precision,\n","      \"Recall@K:\\t%f\" % eval_recall, sep='\\n')"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"U_zikNsHt-32","executionInfo":{"status":"ok","timestamp":1702414068156,"user_tz":300,"elapsed":451,"user":{"displayName":"Haiyue Yang","userId":"01341272776966740941"}},"outputId":"5bcac75b-1792-49ef-e2b4-2d9e12eb21f7"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["MAP:\t0.135777\n","NDCG:\t0.447739\n","Precision@K:\t0.392895\n","Recall@K:\t0.214650\n"]}]},{"cell_type":"code","source":[],"metadata":{"id":"IAymMpLrmtRO"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":[],"metadata":{"id":"EIRxEyLWmtpg"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["model_movie_hard = LightGCN(hparams, data, seed=SEED)\n","\n","with Timer() as train_time:\n","    model_movie_hard.fit(neg_mode=\"hard\", neg_size=10)\n","\n","print(\"Took {} seconds for training.\".format(train_time.interval))"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"outputId":"7cd77d09-e7df-4d5c-b0aa-ee4606ae2b64","id":"BjWSi5vowaYj","executionInfo":{"status":"ok","timestamp":1702414130954,"user_tz":300,"elapsed":62378,"user":{"displayName":"Haiyue Yang","userId":"01341272776966740941"}}},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["Already create adjacency matrix.\n","Already normalize adjacency matrix.\n","Using xavier initialization.\n","Epoch 1 (train)2.6s: train loss = 0.40600 = (mf)0.40559 + (embed)0.00041\n","Epoch 2 (train)1.8s: train loss = 0.27268 = (mf)0.27183 + (embed)0.00085\n","Epoch 3 (train)1.8s: train loss = 0.25265 = (mf)0.25156 + (embed)0.00109\n","Epoch 4 (train)1.8s: train loss = 0.23157 = (mf)0.23028 + (embed)0.00129\n","Epoch 5 (train)1.8s + (eval)0.2s: train loss = 0.21923 = (mf)0.21772 + (embed)0.00151, recall = 0.17226, ndcg = 0.38236, precision = 0.33415, map = 0.10513\n","Epoch 6 (train)2.3s: train loss = 0.20382 = (mf)0.20208 + (embed)0.00174\n","Epoch 7 (train)2.6s: train loss = 0.19614 = (mf)0.19419 + (embed)0.00195\n","Epoch 8 (train)2.2s: train loss = 0.19269 = (mf)0.19056 + (embed)0.00212\n","Epoch 9 (train)1.8s: train loss = 0.18461 = (mf)0.18232 + (embed)0.00228\n","Epoch 10 (train)1.8s + (eval)0.2s: train loss = 0.18133 = (mf)0.17889 + (embed)0.00243, recall = 0.18188, ndcg = 0.39019, precision = 0.34115, map = 0.11074\n","Epoch 11 (train)1.8s: train loss = 0.17871 = (mf)0.17612 + (embed)0.00259\n","Epoch 12 (train)1.8s: train loss = 0.17309 = (mf)0.17037 + (embed)0.00273\n","Epoch 13 (train)1.8s: train loss = 0.17056 = (mf)0.16768 + (embed)0.00288\n","Epoch 14 (train)2.4s: train loss = 0.16619 = (mf)0.16314 + (embed)0.00306\n","Epoch 15 (train)2.5s + (eval)0.4s: train loss = 0.16308 = (mf)0.15985 + (embed)0.00323, recall = 0.19783, ndcg = 0.41759, precision = 0.36543, map = 0.12284\n","Epoch 16 (train)2.0s: train loss = 0.15689 = (mf)0.15347 + (embed)0.00342\n","Epoch 17 (train)1.7s: train loss = 0.15292 = (mf)0.14932 + (embed)0.00360\n","Epoch 18 (train)1.7s: train loss = 0.15301 = (mf)0.14922 + (embed)0.00379\n","Epoch 19 (train)1.7s: train loss = 0.15014 = (mf)0.14616 + (embed)0.00398\n","Epoch 20 (train)1.7s + (eval)0.2s: train loss = 0.14312 = (mf)0.13893 + (embed)0.00419, recall = 0.20434, ndcg = 0.43331, precision = 0.37444, map = 0.13026\n","Epoch 21 (train)1.9s: train loss = 0.14092 = (mf)0.13654 + (embed)0.00439\n","Epoch 22 (train)2.4s: train loss = 0.13857 = (mf)0.13400 + (embed)0.00458\n","Epoch 23 (train)2.5s: train loss = 0.13625 = (mf)0.13147 + (embed)0.00477\n","Epoch 24 (train)1.9s: train loss = 0.13276 = (mf)0.12777 + (embed)0.00498\n","Epoch 25 (train)1.7s + (eval)0.2s: train loss = 0.13120 = (mf)0.12599 + (embed)0.00521, recall = 0.21132, ndcg = 0.44636, precision = 0.38865, map = 0.13621\n","Epoch 26 (train)1.7s: train loss = 0.12466 = (mf)0.11923 + (embed)0.00544\n","Epoch 27 (train)1.7s: train loss = 0.12369 = (mf)0.11804 + (embed)0.00566\n","Epoch 28 (train)1.7s: train loss = 0.12214 = (mf)0.11628 + (embed)0.00586\n","Epoch 29 (train)1.8s: train loss = 0.11875 = (mf)0.11268 + (embed)0.00607\n","Epoch 30 (train)2.4s + (eval)0.4s: train loss = 0.11803 = (mf)0.11173 + (embed)0.00630, recall = 0.21620, ndcg = 0.45299, precision = 0.39491, map = 0.13873\n","Took 60.73995294899987 seconds for training.\n"]}]},{"cell_type":"code","source":["topk_scores = model_movie_hard.recommend_k_items(test, top_k=TOP_K, remove_seen=True)\n","\n","eval_map = map_at_k(test, topk_scores, k=TOP_K)\n","eval_ndcg = ndcg_at_k(test, topk_scores, k=TOP_K)\n","eval_precision = precision_at_k(test, topk_scores, k=TOP_K)\n","eval_recall = recall_at_k(test, topk_scores, k=TOP_K)\n","\n","print(\"MAP:\\t%f\" % eval_map,\n","      \"NDCG:\\t%f\" % eval_ndcg,\n","      \"Precision@K:\\t%f\" % eval_precision,\n","      \"Recall@K:\\t%f\" % eval_recall, sep='\\n')"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"_tEfwhPGwaYj","executionInfo":{"status":"ok","timestamp":1702414131693,"user_tz":300,"elapsed":754,"user":{"displayName":"Haiyue Yang","userId":"01341272776966740941"}},"outputId":"4e1e32b3-24ad-41da-8d2a-5c3b65ac60ab"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["MAP:\t0.138731\n","NDCG:\t0.452987\n","Precision@K:\t0.394910\n","Recall@K:\t0.216197\n"]}]},{"cell_type":"code","source":[],"metadata":{"id":"m3rtJYl4mttO"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":[],"metadata":{"id":"iImh3bSjmtvp"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["model_movie_hard = LightGCN(hparams, data, seed=SEED)\n","\n","with Timer() as train_time:\n","    model_movie_hard.fit(neg_mode=\"hard\", neg_size=10)\n","\n","print(\"Took {} seconds for training.\".format(train_time.interval))"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"outputId":"410b6776-2b0e-4023-fcda-309d2c919adc","id":"dKbhJ6A1wbYr","executionInfo":{"status":"ok","timestamp":1702413938720,"user_tz":300,"elapsed":62315,"user":{"displayName":"Haiyue Yang","userId":"01341272776966740941"}}},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["Already create adjacency matrix.\n","Already normalize adjacency matrix.\n","Using xavier initialization.\n","Epoch 1 (train)3.2s: train loss = 0.41439 = (mf)0.41400 + (embed)0.00039\n","Epoch 2 (train)1.7s: train loss = 0.27780 = (mf)0.27701 + (embed)0.00079\n","Epoch 3 (train)1.7s: train loss = 0.25488 = (mf)0.25383 + (embed)0.00104\n","Epoch 4 (train)1.7s: train loss = 0.24570 = (mf)0.24447 + (embed)0.00123\n","Epoch 5 (train)1.7s + (eval)0.2s: train loss = 0.22777 = (mf)0.22634 + (embed)0.00143, recall = 0.16571, ndcg = 0.36184, precision = 0.31930, map = 0.09713\n","Epoch 6 (train)1.7s: train loss = 0.20892 = (mf)0.20723 + (embed)0.00169\n","Epoch 7 (train)2.3s: train loss = 0.19873 = (mf)0.19681 + (embed)0.00193\n","Epoch 8 (train)2.7s: train loss = 0.19270 = (mf)0.19055 + (embed)0.00215\n","Epoch 9 (train)2.3s: train loss = 0.18996 = (mf)0.18763 + (embed)0.00233\n","Epoch 10 (train)1.8s + (eval)0.2s: train loss = 0.18035 = (mf)0.17786 + (embed)0.00249, recall = 0.18722, ndcg = 0.39592, precision = 0.34889, map = 0.11192\n","Epoch 11 (train)1.7s: train loss = 0.17749 = (mf)0.17483 + (embed)0.00266\n","Epoch 12 (train)1.7s: train loss = 0.16985 = (mf)0.16703 + (embed)0.00282\n","Epoch 13 (train)1.7s: train loss = 0.16932 = (mf)0.16633 + (embed)0.00298\n","Epoch 14 (train)1.7s: train loss = 0.16552 = (mf)0.16236 + (embed)0.00316\n","Epoch 15 (train)2.2s + (eval)0.4s: train loss = 0.16436 = (mf)0.16104 + (embed)0.00332, recall = 0.19338, ndcg = 0.41411, precision = 0.36045, map = 0.12008\n","Epoch 16 (train)2.5s: train loss = 0.15931 = (mf)0.15582 + (embed)0.00349\n","Epoch 17 (train)2.2s: train loss = 0.15445 = (mf)0.15078 + (embed)0.00367\n","Epoch 18 (train)1.8s: train loss = 0.15341 = (mf)0.14958 + (embed)0.00384\n","Epoch 19 (train)1.8s: train loss = 0.14949 = (mf)0.14547 + (embed)0.00402\n","Epoch 20 (train)1.8s + (eval)0.2s: train loss = 0.14590 = (mf)0.14171 + (embed)0.00420, recall = 0.20326, ndcg = 0.42924, precision = 0.37296, map = 0.12816\n","Epoch 21 (train)1.8s: train loss = 0.14184 = (mf)0.13746 + (embed)0.00437\n","Epoch 22 (train)1.9s: train loss = 0.13923 = (mf)0.13467 + (embed)0.00456\n","Epoch 23 (train)2.4s: train loss = 0.13502 = (mf)0.13025 + (embed)0.00477\n","Epoch 24 (train)2.5s: train loss = 0.13514 = (mf)0.13018 + (embed)0.00496\n","Epoch 25 (train)2.0s + (eval)0.2s: train loss = 0.13207 = (mf)0.12692 + (embed)0.00516, recall = 0.20718, ndcg = 0.44345, precision = 0.38420, map = 0.13530\n","Epoch 26 (train)1.8s: train loss = 0.12900 = (mf)0.12365 + (embed)0.00535\n","Epoch 27 (train)1.7s: train loss = 0.12554 = (mf)0.11999 + (embed)0.00555\n","Epoch 28 (train)1.7s: train loss = 0.12384 = (mf)0.11809 + (embed)0.00575\n","Epoch 29 (train)1.7s: train loss = 0.12140 = (mf)0.11546 + (embed)0.00594\n","Epoch 30 (train)1.8s + (eval)0.4s: train loss = 0.12078 = (mf)0.11463 + (embed)0.00615, recall = 0.21308, ndcg = 0.44959, precision = 0.39321, map = 0.13763\n","Took 60.73639951399991 seconds for training.\n"]}]},{"cell_type":"code","source":["topk_scores = model_movie_hard.recommend_k_items(test, top_k=TOP_K, remove_seen=True)\n","\n","eval_map = map_at_k(test, topk_scores, k=TOP_K)\n","eval_ndcg = ndcg_at_k(test, topk_scores, k=TOP_K)\n","eval_precision = precision_at_k(test, topk_scores, k=TOP_K)\n","eval_recall = recall_at_k(test, topk_scores, k=TOP_K)\n","\n","print(\"MAP:\\t%f\" % eval_map,\n","      \"NDCG:\\t%f\" % eval_ndcg,\n","      \"Precision@K:\\t%f\" % eval_precision,\n","      \"Recall@K:\\t%f\" % eval_recall, sep='\\n')"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"s0YdQLaIwbYs","executionInfo":{"status":"ok","timestamp":1702413939476,"user_tz":300,"elapsed":769,"user":{"displayName":"Haiyue Yang","userId":"01341272776966740941"}},"outputId":"0c95c3b3-796a-492f-9db6-acb2fa455a04"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["MAP:\t0.137631\n","NDCG:\t0.449586\n","Precision@K:\t0.393213\n","Recall@K:\t0.213085\n"]}]},{"cell_type":"code","source":[],"metadata":{"id":"8B25I6scqD9F"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["model_movie_hard = LightGCN(hparams, data, seed=SEED)\n","\n","with Timer() as train_time:\n","    model_movie_hard.fit(neg_mode=\"hard\", neg_size=10)\n","\n","print(\"Took {} seconds for training.\".format(train_time.interval))"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"outputId":"5e554330-18e2-40aa-db78-bf044652c54e","id":"btXq9pFZwcXc","executionInfo":{"status":"ok","timestamp":1702413814925,"user_tz":300,"elapsed":61994,"user":{"displayName":"Haiyue Yang","userId":"01341272776966740941"}}},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["Already create adjacency matrix.\n","Already normalize adjacency matrix.\n","Using xavier initialization.\n","Epoch 1 (train)2.3s: train loss = 0.42283 = (mf)0.42246 + (embed)0.00037\n","Epoch 2 (train)1.7s: train loss = 0.28597 = (mf)0.28522 + (embed)0.00075\n","Epoch 3 (train)1.7s: train loss = 0.25731 = (mf)0.25628 + (embed)0.00103\n","Epoch 4 (train)1.7s: train loss = 0.24234 = (mf)0.24111 + (embed)0.00123\n","Epoch 5 (train)1.7s + (eval)0.3s: train loss = 0.22740 = (mf)0.22597 + (embed)0.00143, recall = 0.16689, ndcg = 0.36625, precision = 0.32131, map = 0.09719\n","Epoch 6 (train)2.3s: train loss = 0.21128 = (mf)0.20960 + (embed)0.00168\n","Epoch 7 (train)2.4s: train loss = 0.19689 = (mf)0.19495 + (embed)0.00194\n","Epoch 8 (train)2.0s: train loss = 0.18827 = (mf)0.18611 + (embed)0.00216\n","Epoch 9 (train)1.7s: train loss = 0.19020 = (mf)0.18787 + (embed)0.00233\n","Epoch 10 (train)1.7s + (eval)0.2s: train loss = 0.18092 = (mf)0.17842 + (embed)0.00250, recall = 0.18183, ndcg = 0.39208, precision = 0.34390, map = 0.11046\n","Epoch 11 (train)1.7s: train loss = 0.18104 = (mf)0.17838 + (embed)0.00266\n","Epoch 12 (train)1.8s: train loss = 0.17458 = (mf)0.17178 + (embed)0.00280\n","Epoch 13 (train)1.9s: train loss = 0.17348 = (mf)0.17053 + (embed)0.00295\n","Epoch 14 (train)2.4s: train loss = 0.16706 = (mf)0.16396 + (embed)0.00310\n","Epoch 15 (train)2.6s + (eval)0.4s: train loss = 0.16278 = (mf)0.15952 + (embed)0.00326, recall = 0.19870, ndcg = 0.42366, precision = 0.36819, map = 0.12589\n","Epoch 16 (train)2.0s: train loss = 0.15847 = (mf)0.15502 + (embed)0.00345\n","Epoch 17 (train)1.7s: train loss = 0.15589 = (mf)0.15225 + (embed)0.00364\n","Epoch 18 (train)1.7s: train loss = 0.15181 = (mf)0.14797 + (embed)0.00384\n","Epoch 19 (train)1.7s: train loss = 0.14359 = (mf)0.13954 + (embed)0.00405\n","Epoch 20 (train)1.7s + (eval)0.2s: train loss = 0.14167 = (mf)0.13743 + (embed)0.00424, recall = 0.20361, ndcg = 0.43420, precision = 0.37497, map = 0.13072\n","Epoch 21 (train)2.0s: train loss = 0.14515 = (mf)0.14074 + (embed)0.00441\n","Epoch 22 (train)2.5s: train loss = 0.13837 = (mf)0.13377 + (embed)0.00460\n","Epoch 23 (train)2.6s: train loss = 0.13510 = (mf)0.13032 + (embed)0.00478\n","Epoch 24 (train)1.9s: train loss = 0.13277 = (mf)0.12780 + (embed)0.00497\n","Epoch 25 (train)1.8s + (eval)0.2s: train loss = 0.12915 = (mf)0.12396 + (embed)0.00519, recall = 0.21022, ndcg = 0.44489, precision = 0.38802, map = 0.13366\n","Epoch 26 (train)1.7s: train loss = 0.12579 = (mf)0.12039 + (embed)0.00539\n","Epoch 27 (train)1.7s: train loss = 0.12276 = (mf)0.11717 + (embed)0.00559\n","Epoch 28 (train)1.7s: train loss = 0.12381 = (mf)0.11800 + (embed)0.00581\n","Epoch 29 (train)2.0s: train loss = 0.11939 = (mf)0.11338 + (embed)0.00601\n","Epoch 30 (train)2.4s + (eval)0.3s: train loss = 0.12115 = (mf)0.11497 + (embed)0.00619, recall = 0.21281, ndcg = 0.45268, precision = 0.39258, map = 0.13743\n","Took 60.553142866999906 seconds for training.\n"]}]},{"cell_type":"code","source":["topk_scores = model_movie_hard.recommend_k_items(test, top_k=TOP_K, remove_seen=True)\n","\n","eval_map = map_at_k(test, topk_scores, k=TOP_K)\n","eval_ndcg = ndcg_at_k(test, topk_scores, k=TOP_K)\n","eval_precision = precision_at_k(test, topk_scores, k=TOP_K)\n","eval_recall = recall_at_k(test, topk_scores, k=TOP_K)\n","\n","print(\"MAP:\\t%f\" % eval_map,\n","      \"NDCG:\\t%f\" % eval_ndcg,\n","      \"Precision@K:\\t%f\" % eval_precision,\n","      \"Recall@K:\\t%f\" % eval_recall, sep='\\n')"],"metadata":{"colab":{"base_uri":"https://localhost:8080/"},"id":"avsFptxVwcXk","executionInfo":{"status":"ok","timestamp":1702413815186,"user_tz":300,"elapsed":266,"user":{"displayName":"Haiyue Yang","userId":"01341272776966740941"}},"outputId":"f01d9d11-1528-4a07-db00-de0793b85b08"},"execution_count":null,"outputs":[{"output_type":"stream","name":"stdout","text":["MAP:\t0.137427\n","NDCG:\t0.452683\n","Precision@K:\t0.392577\n","Recall@K:\t0.212811\n"]}]}],"metadata":{"accelerator":"GPU","colab":{"provenance":[],"collapsed_sections":["w80knzRVzIO_"]},"kernelspec":{"display_name":"Python 3","name":"python3"},"language_info":{"name":"python"}},"nbformat":4,"nbformat_minor":0}